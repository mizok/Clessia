<header class="shell-header">
  <div class="shell-header__left">
    <span class="shell-header__logo-icon">C</span>
    <span class="shell-header__logo-text">Clessia</span>
  </div>
  <div class="shell-header__right">
    @if (auth.activeRole(); as role) {
      @if (auth.roles().length > 1) {
        @if (device.isTouchDevice()) {
          <button
            class="shell-header__role-badge shell-header__role-badge--{{ role }} shell-header__role-badge--interactive"
            (click)="auth.openRolePicker()"
          >
            {{ roleLabels[role] }}
            <i class="pi pi-chevron-down"></i>
          </button>
        } @else {
          <button
            class="shell-header__role-badge shell-header__role-badge--{{ role }} shell-header__role-badge--interactive"
            (click)="auth.openRolePicker()"
            pTooltip="你擁有多個角色，點擊即可切換"
            tooltipPosition="bottom"
            tooltipStyleClass="clessia-tooltip clessia-tooltip--role-switch"
            appAutoOpenTooltip
            [appAutoOpenTooltipEnterDelay]="500"
            [appAutoOpenTooltipEnterDuration]="220"
            [appAutoOpenTooltipLeaveDuration]="220"
          >
            {{ roleLabels[role] }}
            <i class="pi pi-chevron-down"></i>
          </button>
        }
      } @else {
        <span class="shell-header__role-badge shell-header__role-badge--{{ role }}">
          {{ roleLabels[role] }}
        </span>
      }
    }

    <div class="shell-header__user" #userTrigger (click)="op.toggle($event, userTrigger)">
      <app-jdenticon-avatar class="shell-header__avatar" [size]="30" [value]="avatarSeed()" />
      <span class="shell-header__user-name">{{ auth.profile()?.display_name || auth.user()?.email }}</span>
    </div>

    <p-popover #op styleClass="user-menu-overlay" appendTo="body">
      <div class="user-menu">
        <div class="user-menu__info">
          <app-jdenticon-avatar class="user-menu__avatar" [size]="48" [value]="avatarSeed()" />
          <div class="user-menu__text">
            <span class="user-menu__name">{{ auth.profile()?.display_name || 'User' }}</span>
            <span class="user-menu__email">{{ auth.user()?.email }}</span>
          </div>
        </div>
        <hr class="user-menu__divider" />
        <div class="user-menu__items">
          <button class="user-menu__item" (click)="changePassword()">
            <i class="pi pi-key"></i>
            修改密碼
          </button>
          <button class="user-menu__item user-menu__item--danger" (click)="signOut()">
            <i class="pi pi-sign-out"></i>
            登出
          </button>
        </div>
      </div>
    </p-popover>
  </div>
</header>

@if (hasSubheader()) {
  <div class="shell-subheader">
    <ng-content select="[subheader]" />
  </div>
}

<div class="shell-layout" [class.shell-layout--has-subheader]="hasSubheader()">
  <div class="shell-container">
    <aside class="shell-sidebar">
      <nav class="shell-nav">
        @for (group of groupedNav(); track group.label) {
          @if (group.label) {
            <div class="shell-nav__group-label">{{ group.label }}</div>
          }
          @for (item of group.items; track item.route) {
            <a
              class="shell-nav__item"
              [routerLink]="item.route"
              routerLinkActive="shell-nav__item--active"
            >
              <i class="pi {{ item.icon }} shell-nav__icon"></i>
              <span class="shell-nav__label">{{ item.label }}</span>
              @if (item.badge) {
                <span class="shell-nav__badge">{{ item.badge }}</span>
              }
            </a>
          }
        }
      </nav>
    </aside>

    <main class="shell-content" [class.shell-content--centered]="centered()">
      <ng-content />
    </main>
  </div>
</div>

<!-- Mobile Bottom Navigation -->
@if (navItems().length > 0) {
  <nav class="shell-bottom-nav">
    @for (item of primaryTabs(); track item.route) {
      <a
        class="shell-bottom-nav__tab"
        [routerLink]="item.route"
        routerLinkActive="shell-bottom-nav__tab--active"
      >
        <i class="pi {{ item.icon }}"></i>
        <span>{{ item.label }}</span>
      </a>
    }
    @if (moreTabs().length > 0) {
      <button
        class="shell-bottom-nav__tab"
        [class.shell-bottom-nav__tab--active]="moreOpen()"
        (click)="toggleMore()"
      >
        <i class="pi pi-ellipsis-h"></i>
        <span>更多</span>
      </button>
    }
  </nav>

  @if (moreOpen() || moreClosing()) {
    <div class="shell-more-overlay" [class.closing]="moreClosing()" (click)="closeMore()"></div>
    <div class="shell-more-sheet" [class.closing]="moreClosing()">
      <div class="shell-more-sheet__handle"></div>
      <div class="shell-more-sheet__grid">
        @for (item of moreTabs(); track item.route) {
          <a
            class="shell-more-sheet__item"
            [routerLink]="item.route"
            routerLinkActive="shell-more-sheet__item--active"
            (click)="closeMore()"
          >
            <i class="pi {{ item.icon }}"></i>
            <span>{{ item.label }}</span>
          </a>
        }
      </div>
    </div>
  }
}
